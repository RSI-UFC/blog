<!DOCTYPE html>
<html class="no-js" lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Escrevendo Aplicações Nativas para Windows - Parte 2 | RSI</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="stylesheet" href="/blog/css/bundle.css">
	<link rel="icon" href="/blog/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="/blog/icons/32.png" sizes="32x32" type="image/png">
		
</head>
<body class="body kind-page">
	<header class="header">
	<a class="logo" href="/blog">RSI</a>
	
<nav class="main-nav" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="/blog/authors/">
					
					<span class="main-nav__text">Autores</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="/blog/tags/">
					
					<span class="main-nav__text">Tags</span>
					
				</a>
			</li>
			<li class="main-nav__item main-nav__item--active">
				
					
					<span class="main-nav__text">Posts</span>
					
				
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
		<div class="single block">
			<article class="entry">
				<h1 class="entry__title">Escrevendo Aplicações Nativas para Windows - Parte 2</h1>
				<div class="entry__content"><blockquote>
<p><em>Por Davi Chaves</em></p>
</blockquote>
<p>Até o momento, temos uma aplicação nativa, mas não conseguimos printar nada. Uma forma de construirmos essa funcionalidade seria fazer nosso processo native escrever no standard output do processo pai. Entretanto, eu acabei encontrando algumas dificuldades nessa solução. Dessa forma, vamos utilizar uma outra alternativa: criar um arquivo output.txt e escrever todos as saidas do nosso programa nele.</p>
<h1 id="criando-e-escrevendo-em-um-arquivo">Criando e Escrevendo em um Arquivo</h1>
<p>Para isso, vamos ter que utilizar duas APIs: NtCreateFile e NtWriteFile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>NTSYSCALLAPI
</span></span><span style="display:flex;"><span>NTSTATUS
</span></span><span style="display:flex;"><span>NTAPI
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NtCreateFile</span>(
</span></span><span style="display:flex;"><span>    _Out_ PHANDLE FileHandle,
</span></span><span style="display:flex;"><span>    _In_ ACCESS_MASK DesiredAccess,
</span></span><span style="display:flex;"><span>    _In_ POBJECT_ATTRIBUTES ObjectAttributes,
</span></span><span style="display:flex;"><span>    _Out_ PIO_STATUS_BLOCK IoStatusBlock,
</span></span><span style="display:flex;"><span>    _In_opt_ PLARGE_INTEGER AllocationSize,
</span></span><span style="display:flex;"><span>    _In_ ULONG FileAttributes,
</span></span><span style="display:flex;"><span>    _In_ ULONG ShareAccess,
</span></span><span style="display:flex;"><span>    _In_ ULONG CreateDisposition,
</span></span><span style="display:flex;"><span>    _In_ ULONG CreateOptions,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_In_reads_bytes_opt_</span>(EaLength) PVOID EaBuffer,
</span></span><span style="display:flex;"><span>    _In_ ULONG EaLength
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>NTSYSCALLAPI
</span></span><span style="display:flex;"><span>NTSTATUS
</span></span><span style="display:flex;"><span>NTAPI
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NtWriteFile</span>(
</span></span><span style="display:flex;"><span>    _In_ HANDLE FileHandle,
</span></span><span style="display:flex;"><span>    _In_opt_ HANDLE Event,
</span></span><span style="display:flex;"><span>    _In_opt_ PIO_APC_ROUTINE ApcRoutine,
</span></span><span style="display:flex;"><span>    _In_opt_ PVOID ApcContext,
</span></span><span style="display:flex;"><span>    _Out_ PIO_STATUS_BLOCK IoStatusBlock,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_In_reads_bytes_</span>(Length) PVOID Buffer,
</span></span><span style="display:flex;"><span>    _In_ ULONG Length,
</span></span><span style="display:flex;"><span>    _In_opt_ PLARGE_INTEGER ByteOffset,
</span></span><span style="display:flex;"><span>    _In_opt_ PULONG Key
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>As documentações dessas APIs podem ser encontradas na página da Microsoft.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;phnt_windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;phnt.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib, &#34;ntdll&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">NtProcessStartup</span>(PPEB _peb) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Cria o caminho do arquivo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WCHAR _path[] <span style="color:#f92672">=</span> <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">??</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">IEUser</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Desktop</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">output.txt&#34;</span>;
</span></span><span style="display:flex;"><span>    UNICODE_STRING path;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>path, _path);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Cria os atributos
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    OBJECT_ATTRIBUTES fileAttr <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTL_CONSTANT_OBJECT_ATTRIBUTES</span>(<span style="color:#f92672">&amp;</span>path, OBJ_CASE_INSENSITIVE);
</span></span><span style="display:flex;"><span>    IO_STATUS_BLOCK ioStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// hFile vai receber o HANDLE do arquivo criado
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    HANDLE hFile;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NtCreateFile</span>(<span style="color:#f92672">&amp;</span>hFile, GENERIC_WRITE <span style="color:#f92672">|</span> SYNCHRONIZE, <span style="color:#f92672">&amp;</span>fileAttr, <span style="color:#f92672">&amp;</span>ioStatus, nullptr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, FILE_SUPERSEDE, FILE_SYNCHRONOUS_IO_NONALERT, nullptr, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Escreve no arquivo utilizando o hFile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> buffer[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello World&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NtWriteFile</span>(hFile, nullptr, nullptr, nullptr, <span style="color:#f92672">&amp;</span>ioStatus, (PVOID)buffer, (ULONG)<span style="color:#a6e22e">strlen</span>(buffer), nullptr, nullptr);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NtClose</span>(hFile);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Se lembre de alterar o _path para o valor desejado.
Esse código vai criar um arquivo na área de trabalho e depois escrever o que tiver no buffer nele. Já daria para utilizar isso como um &ldquo;printf&rdquo;. Mas podemos fazer melhor.</p>
<h1 id="simulando-o-printf">Simulando o printf</h1>
<p>Para isso, vamos utilizar a função <code>vsprintf_s</code>, que é basicamente um versão da <code>sprintf_s</code> que recebe uma lista de argumentos. Observe que tivemos que declarar a função <code>vsprintf_s</code> pois por algum motivo ela não está declarada nos headers. Além disso, para termos uma sintáxe mais limpa, estamos acessando o HANDLE hFile de forma global.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define PAGE_SIZE 0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>HANDLE hFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">vsprintf_s</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> numberOfElements,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> format,
</span></span><span style="display:flex;"><span>    va_list argptr
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">printf</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> format, ...) {
</span></span><span style="display:flex;"><span>    va_list args;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">va_start</span>(args, format);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[PAGE_SIZE] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vsprintf_s</span>(buffer, PAGE_SIZE, format, args);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">va_end</span>(args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    IO_STATUS_BLOCK ioStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NtWriteFile</span>(hFile, nullptr, nullptr, nullptr, <span style="color:#f92672">&amp;</span>ioStatus, (PVOID)buffer, (ULONG)<span style="color:#a6e22e">strnlen</span>(buffer, PAGE_SIZE), nullptr, nullptr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Podemos, também, colocar o resto do código em funções.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">OpenOutputFile</span>(PHANDLE phFile) {
</span></span><span style="display:flex;"><span>	WCHAR _path[MAX_PATH] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">swprintf_s</span>(_path, <span style="color:#a6e22e">ARRAYSIZE</span>(_path), <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">??</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">%ls%ls&#34;</span>, peb<span style="color:#f92672">-&gt;</span>ProcessParameters<span style="color:#f92672">-&gt;</span>CurrentDirectory.DosPath.Buffer, <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;output.txt&#34;</span>);
</span></span><span style="display:flex;"><span>	UNICODE_STRING path;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>path, _path);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK ioStatus;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES fileAttr <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTL_CONSTANT_OBJECT_ATTRIBUTES</span>(<span style="color:#f92672">&amp;</span>path, OBJ_CASE_INSENSITIVE);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NtCreateFile</span>(phFile, GENERIC_WRITE <span style="color:#f92672">|</span> SYNCHRONIZE, <span style="color:#f92672">&amp;</span>fileAttr, <span style="color:#f92672">&amp;</span>ioStatus, nullptr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, FILE_SUPERSEDE, FILE_SYNCHRONOUS_IO_NONALERT, nullptr, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">CloseOutputFile</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NtClose</span>(hFile);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Perceba que a primeira função pega um HANDLE para o arquivo de saída. Diante disso, temos que chama-lá no início da execução do nosso programa e, ao final, devemos fechar esse HANDLE.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">NtProcessStartup</span>(PPEB peb) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">NT_SUCCESS</span>(<span style="color:#a6e22e">OpenOutputFile</span>(<span style="color:#f92672">&amp;</span>hFile))) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Hello World! %s %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;exemple&#34;</span>, <span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">CloseOutputFile</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>É importante notar que não estamos fazendo muito as tratativas de possíveis erros por simplicidade.</p>
<h1 id="conclusão">Conclusão</h1>
<p>Podemos simular a funcionalide do <code>printf</code> escrevendo em um arquivo de texto qualquer. Em artigos futuros vamos fazer com que o output do nosso programa nativo seja mostrado pelo console.</p>
</div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="/blog/tags/native-dll/">native-dll</a>
			<a class="entry__tag btn" href="/blog/tags/dev/">dev</a>
</div>
					
				</footer>
				
			</article>
		</div>
	</main>
	
	



	

	</div>
	<footer class="footer">
	<div class="footer__copyright">© 2024 RSI. <span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span></div>
</footer>
<script src="/blog/js/menu.js"></script>
</body>
</html>
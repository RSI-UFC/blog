<!DOCTYPE html>
<html class="no-js" lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>SIGMA Rules Introduction - Parte 01 | RSI</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="stylesheet" href="/blog/css/bundle.css">
	<link rel="icon" href="/blog/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="/blog/icons/32.png" sizes="32x32" type="image/png">
		
</head>
<body class="body kind-page">
	<header class="header">
	<a class="logo" href="/blog">RSI</a>
	
<nav class="main-nav" role="navigation">
	<button id="toggle" class="main-nav__btn" aria-label="Menu toggle" aria-expanded="false" tabindex="0">
		<div class="main-nav__btn-box" tabindex="-1">
			<svg class="main-nav__icon icon-menu" width="18" height="18" viewBox="0 0 18 18">
				<path class="icon-menu__burger" d="M18 0v3.6H0V0h18zM0 10.8h18V7.2H0v3.6zM0 18h18v-3.6H0V18z"/>
				<path class="icon-menu__x" d="M11.55 9L18 15.45 15.45 18 9 11.55 2.55 18 0 15.45 6.45 9 0 2.55 2.55 0 9 6.45 15.45 0 18 2.55 11.55 9z"/>
			</svg>
		</div>
	</button>
	<ul id="menu" class="main-nav__list">
			<li class="main-nav__item">
				<a class="main-nav__link" href="/blog/authors/">
					
					<span class="main-nav__text">Autores</span>
					
				</a>
			</li>
			<li class="main-nav__item">
				<a class="main-nav__link" href="/blog/tags/">
					
					<span class="main-nav__text">Tags</span>
					
				</a>
			</li>
			<li class="main-nav__item main-nav__item--active">
				
					
					<span class="main-nav__text">Posts</span>
					
				
			</li>
	</ul>
</nav>
</header>
	<div class="primary">
	
	<main class="main">
		
		<div class="single block">
			<article class="entry">
				<h1 class="entry__title">SIGMA Rules Introduction - Parte 01</h1>
				<div class="entry__content"><blockquote>
<p><em>Por Davi Chaves</em></p>
</blockquote>
<p><strong>Table of Contents</strong></p>
<ol>
<li>[[#Campo Logsource|Campo Logsource]]</li>
<li>[[#Campo Detection|Campo Detection]]
<ol>
<li>[[#Campo Detection#Selection|Selection]]</li>
<li>[[#Campo Detection#Condition|Condition]]</li>
<li>[[#Campo Detection#Image, CommandLine&hellip; what are they?|Image, CommandLine&hellip; what are they?]]</li>
<li>[[#Campo Detection#Modificadores|Modificadores]]</li>
</ol>
</li>
</ol>
<p>![[Pasted image 20240109134022.png]]
Anteriormente, as detecções no âmbito do SIEM eram isoladas em compartimentos específicos vinculados a fornecedores ou plataformas particulares. Parceiros que pretendiam compartilhar conteúdo de detecção muitas vezes enfrentavam o desafio de <strong>traduzir uma consulta de um fornecedor para outro</strong>. Essa abordagem revelou-se insustentável.
Assim como YARA ou as regras do Snort, o SIGMA representa outra ferramenta voltada para o compartilhamento aberto de detecções, mas com foco no SIEM em vez de arquivos ou tráfego de rede. O SIGMA capacita defensores a compartilhar detecções (alertas, casos de uso) <strong>em uma linguagem comum</strong>.</p>
<h1 id="tipos-de-regras-sigma">Tipos de regras SIGMA</h1>
<p>Existem atualmente dois tipos básicos de regras no SIGMA que podem ser expressos:</p>
<ol>
<li><strong>Regras SIGMA baseadas em correspondência:</strong> amplamente suportadas e mais fáceis de escrever, essas regras são centradas na correspondência direta. Exemplo: uma regra que trás os usuários que falharam em se autenticar.</li>
<li><strong>Regras SIGMA baseadas em correspondência e correlações simples:</strong> com suporte limitado e uma complexidade um pouco maior de escrita, essas regras envolvem não apenas a correspondência, mas também correlações simples. Exemplo: uma regra que trás os usuários que falharam em se autenticar X vezes em um intervalo de tempo específico. <strong>Nesse artigo não vamos abordar esse tipo de regra.</strong></li>
</ol>
<h1 id="funcionamento">Funcionamento</h1>
<p>De forma simplificada, o processo de transformação de uma regra SIGMA em uma detecção real pode ser dividida em 3 partes:</p>
<ol>
<li><strong>Escrita da regra SIGMA:</strong> primeiro, é necessário a criação de uma SIGMA rule.</li>
<li><strong>Backend Transformation:</strong> em seguida, algum backend, como o pySigma-backend-splunk, vai ser responsável por colocar a SIGMA rule no formato de query apropriado. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li><strong>Pipelines:</strong> por último, é possivel utilizar pipelines para mapear os campos genéricos escritos por outros autores de SIGMA rules para os campos específicos do seu ambiente desejado.
O ponto importante aqui é entender que, dado uma mesma SIGMA rule, é possível transforma-lá em diferentes detecções de diferentes SIEMs. Nesse artigo, apenas a escrita das regras SIGMA serão abordadas.
![[out 2.svg]]</li>
</ol>
<h1 id="escrevendo-uma-sigma-rule">Escrevendo uma SIGMA Rule</h1>
<p>Vamos escrever uma regra extremamente simples que detecte execuções do binário <code>CertUtil.exe</code> que contenham na <code>CommandLine</code> flags como <code>-encode</code> ou <code>/encode</code>.
Atualmente, para termos uma regra SIGMA válida, <strong>são necessários apenas dois campos</strong>: <code>logsource</code> e <code>detection</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">logsource</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">product</span>: <span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Image|endswith</span>: <span style="color:#e6db74">&#39;\certutil.exe&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-encode&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/encode&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">selection</span>
</span></span></code></pre></div><p>Antes de entendermos a estrutura dessa regra, é importante entender que é possível converte-lás em detecções de diferentes SIEMs com muita facilidade utilizando o <a href="https://github.com/SigmaHQ/sigma-cli">sigma-cli</a>/<a href="https://github.com/SigmaHQ/pySigma">pySigma</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Splunk Backend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Image<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">certutil.exe&#34;</span> CommandLine <span style="color:#a6e22e">IN</span> (<span style="color:#e6db74">&#34;*-encode*&#34;</span>, <span style="color:#e6db74">&#34;*/encode*&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// QRadar Backend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SELECT <span style="color:#a6e22e">UTF8</span>(payload) as search_payload from events where <span style="color:#e6db74">&#34;Image&#34;</span> ILIKE <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">\</span>certutil.exe<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#a6e22e">AND</span> (<span style="color:#e6db74">&#34;Process CommandLine&#34;</span> ILIKE <span style="color:#a6e22e">ENUMERATION</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">%-</span>encode<span style="color:#f92672">%</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">%/</span>encode<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ElasticSearch Backend
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Image:<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\\</span>certutil.exe <span style="color:#a6e22e">AND</span> (CommandLine:(<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">-</span>encode<span style="color:#f92672">*</span> OR <span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">/</span>encode<span style="color:#f92672">*</span>))
</span></span></code></pre></div><p>Atualmente, os seguintes backends são suportados pelo pySigma em 2022/04/10:</p>
<table>
<thead>
<tr>
<th>pySigma</th>
<th style="text-align:center">Observation</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-pipeline-crowdstrike">pySigma-pipeline-crowdstrike</a></td>
<td style="text-align:center">CrowdStrike Search Processing Language (SPL)</td>
</tr>
<tr>
<td><a href="https://github.com/vastlimits/pySigma-backend-uberAgent/">pySigma-backend-uberAgent</a></td>
<td style="text-align:center">uberAgent ESA Threat Detection Engine</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-splunk">pySigma-backend-splunk</a></td>
<td style="text-align:center">Splunk Search Processing Language (SPL)</td>
</tr>
<tr>
<td><a href="https://github.com/IBM/pySigma-backend-QRadar-AQL">pySigma-backend-QRadar-AQL</a></td>
<td style="text-align:center">IBM Qradar AQL</td>
</tr>
<tr>
<td><a href="https://github.com/cyberphor/pySigma-backend-powershell">pySigma-backend-powershell</a></td>
<td style="text-align:center">PowerShell event log cmdlets</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-opensearch">pySigma-backend-opensearch</a> (proxied by <a href="https://github.com/SigmaHQ/pySigma-backend-elasticsearch">pySigma-backend-elasticsearch</a>)</td>
<td style="text-align:center">OpenSearch search query string. Only searches, no aggregations</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-opensearch">pySigma-backend-opensearch</a> (proxied by <a href="https://github.com/SigmaHQ/pySigma-backend-elasticsearch">pySigma-backend-elasticsearch</a>)</td>
<td style="text-align:center">OpenSearch DSL query</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-opensearch">pySigma-backend-opensearch</a></td>
<td style="text-align:center">OpenSearch monitors and ElasticRule are in Elastic Common Schema</td>
</tr>
<tr>
<td><a href="https://github.com/AttackIQ/pySigma-backend-microsoft365defender">pySigma-backend-microsoft365defender</a></td>
<td style="text-align:center">Microsoft Defender ATP Hunting Queries</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-elasticsearch">pySigma-backend-elasticsearch</a></td>
<td style="text-align:center">Elasticsearch DSL query</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-elasticsearch">pySigma-backend-elasticsearch</a></td>
<td style="text-align:center">Elasticsearch query string. Only searches, no aggregations</td>
</tr>
<tr>
<td><a href="https://github.com/SigmaHQ/pySigma-backend-elasticsearch">pySigma-backend-elasticsearch</a></td>
<td style="text-align:center">Kibana JSON Configuration files (searches only)</td>
</tr>
<tr>
<td>Nesse artigo, <strong>vamos utilizar como exemplo o pySigma-backend-splunk</strong>.</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="campo-logsource">Campo Logsource</h2>
<p>O campo <code>logsource</code> serve apenas como &ldquo;metadado&rdquo; para que os consumidores da regra SIGMA, mais a frente, possam especificar em quais dados essa regra deve ser aplicada. Por exemplo, nesse caso não faria sentido aplicar essa regra em logs de firewall ou do Linux. Portanto, o autor da regra pode escrever <code>product: windows</code> como uma dica que essa regra deve ser aplicada, de preferência, em ambientes Windows. Entretanto, o consumidor dessa regra pode, muito bem, ignorar isso e aplicar em logs de firewall, por exemplo. Além disso, apenas o campo <code>product</code> é obrigatório. Todos os outros podem conter qualquer coisa que o autor quiser.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">logsource</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">banana</span>: <span style="color:#ae81ff">apple</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>: <span style="color:#ae81ff">windows_audit</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">category</span>: <span style="color:#ae81ff">process_creation</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">product</span>: <span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span></code></pre></div><p>Como exemplo, o campo <code>product: windows</code> poderia ser lido por um backend, ou uma pipeline, para introduzir na query de detecção um campo que restrinja à logs do Windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>index<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;CoolCompanyName-windows&#34;</span> Image<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">certutil.exe&#34;</span> CommandLine <span style="color:#a6e22e">IN</span> (<span style="color:#e6db74">&#34;*-encode*&#34;</span>, <span style="color:#e6db74">&#34;*/encode*&#34;</span>)
</span></span></code></pre></div><p>Indo além, o backend, ou pipeline, poderia inserir, para regras que contenham um logsource <code>category: process_creation</code> e <code>service: windows_audit</code>, campos que restrinjam à logs de criação de processos do Windows Audit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>index<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;CoolCompanyName-windows&#34;</span> EventCode<span style="color:#f92672">=</span><span style="color:#ae81ff">4688</span> Image<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;*</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">certutil.exe&#34;</span> CommandLine <span style="color:#a6e22e">IN</span> (<span style="color:#e6db74">&#34;*-encode*&#34;</span>, <span style="color:#e6db74">&#34;*/encode*&#34;</span>)
</span></span></code></pre></div><p>O mais importante é entender que os campos do logsource não fazem nada &ldquo;sozinhos&rdquo;, são os backends e pipelines que podem, ou não, usar essas informações para melhor direcionar as buscas de detecção. Nos próximos artigos vamos ver como escrever backends e pipelines.</p>
<h2 id="campo-detection">Campo Detection</h2>
<p>O componente de detecção é o espaço no qual o autor estabelece os critérios de detecção. Isso envolve, no mínimo, um componente de seleção e um componente de condição.</p>
<h3 id="selection">Selection</h3>
<p>Esse campo pode, na verdade, receber qualquer nome. Entretanto, a documentação utiliza o prefixo <code>selection_</code> para descrever os critérios de detecção.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selection_banana</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Image|endswith</span>: <span style="color:#e6db74">&#39;\certutil.exe&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-encode&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/encode&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">selection_banana</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Query gerada (SPLUNK-SPL)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Image:<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\\</span>certutil.exe <span style="color:#a6e22e">AND</span> (CommandLine:(<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">-</span>encode<span style="color:#f92672">*</span> OR <span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">/</span>encode<span style="color:#f92672">*</span>))
</span></span></code></pre></div><h3 id="condition">Condition</h3>
<p>O campo <code>condition</code> contém a lógica booleana (AND, OR, NOT) que define como cada seleção deve ser incluída na consulta final. Por exemplo, podemos criar uma outra seleção e utilizar ela como filtro.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selection_banana</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Image|endswith</span>: <span style="color:#e6db74">&#39;\certutil.exe&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">CommandLine|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-encode&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/encode&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">filter_bad_banana</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ParentCommandLine|contains</span>: <span style="color:#e6db74">&#39;apple&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">selection_banana and not filter_bad_banana</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Query gerada (SPLUNK-SPL)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>(Image:<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\\</span>certutil.exe <span style="color:#a6e22e">AND</span> (CommandLine:(<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">-</span>encode<span style="color:#f92672">*</span> OR <span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">/</span>encode<span style="color:#f92672">*</span>))) <span style="color:#a6e22e">AND</span> (NOT ParentCommandLine:<span style="color:#f92672">*</span>apple<span style="color:#f92672">*</span>)
</span></span></code></pre></div><p>Normalmente, é utilizado o prefíxo <code>filter_</code> para seleções agem como um tipo de filtro.</p>
<h3 id="image-commandline-what-are-they">Image, CommandLine&hellip; what are they?</h3>
<p>Os subcomponentes do campo de seleção possuem a estrutura de <code>field: value</code>. Teoricamente, o autor pode utilizar os nomes de campo que desejar, desde que alguém esteja disposto a dedicar tempo para escrever especificações para traduzir esses campos para os deles. Diante disso, é bom seguir uma certa convenção para que as regras SIGMA sejam mais facilmente utilizadas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Também é válido</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NomeDoProcesso|endswith</span>: <span style="color:#e6db74">&#39;\certutil.exe&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Também é válido</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">LinhaDeComandoDoProcesso|contains</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;-encode&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;/encode&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Query gerada (SPLUNK-SPL)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NomeDoProcesso:<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\\</span>certutil.exe <span style="color:#a6e22e">AND</span> (LinhaDeComandoDoProcesso:(<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">-</span>encode<span style="color:#f92672">*</span> OR <span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">/</span>encode<span style="color:#f92672">*</span>))
</span></span></code></pre></div><h3 id="modificadores">Modificadores</h3>
<p>O que são esses termos <code>endswith</code>, <code>contains</code> e <code>startswith</code>? Eles são chamados de modificadores! Sigma possui modificadores especiais para facilitar a busca de strings não delimitadas:</p>
<ul>
<li>*something &ndash;&gt; endswith modifier</li>
<li>something*  &ndash;&gt; startswith modifier</li>
<li><em>something</em>  &ndash;&gt; contains modifier
Abaixo, os atuais modificadores suportados pelo SIGMA. Vale a pena lembrar que, como tudo nas regras SIGMA, os modificadores não fazem nada &ldquo;sozinhos&rdquo;, vai ser o backend, ou o consumidor da regra, que vai utilizar os campos das regras para construir a detecção desejada.</li>
</ul>
<table>
<thead>
<tr>
<th>Modifier</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr>
<td>contains</td>
<td>the value is matched anywhere in the field (strings and regular expressions)</td>
</tr>
<tr>
<td>startswith</td>
<td>The value is expected at the beginning of the field&rsquo;s content (strings and regular expressions)</td>
</tr>
<tr>
<td>endswith</td>
<td>The value is expected at the end of the field&rsquo;s content (strings and regular expressions)</td>
</tr>
<tr>
<td>exists</td>
<td>The field exists (yes/true) in the matched event or doesn&rsquo;t exist (no/false)</td>
</tr>
<tr>
<td>base64</td>
<td>The value is encoded with Base64</td>
</tr>
<tr>
<td>base64offset</td>
<td>If a value might appear somewhere in a base64-encoded value the representation might change depending on the position in the overall value</td>
</tr>
<tr>
<td>wide</td>
<td>transforms value to UTF16-LE encoding</td>
</tr>
<tr>
<td>re</td>
<td>value is handled as regular expression by backends</td>
</tr>
<tr>
<td>i</td>
<td>Regular expression ignore case modifier</td>
</tr>
<tr>
<td>ignorecase</td>
<td>Regular expression ignore case modifier</td>
</tr>
<tr>
<td>m</td>
<td>Regular expression multiline modifier</td>
</tr>
<tr>
<td>multiline</td>
<td>Regular expression multiline modifier</td>
</tr>
<tr>
<td>s</td>
<td>Regular expression dot matches all modifier</td>
</tr>
<tr>
<td>dotall</td>
<td>Regular expression dot matches all modifier</td>
</tr>
<tr>
<td>cidr</td>
<td>value is handled as an IPv4 CIDR by backends</td>
</tr>
<tr>
<td>all</td>
<td>This modifier changes OR logic to AND</td>
</tr>
<tr>
<td>lt</td>
<td>Field is less than the value</td>
</tr>
<tr>
<td>lte</td>
<td>Field is less or egal than the value</td>
</tr>
<tr>
<td>gt</td>
<td>Field is Greater than the value</td>
</tr>
<tr>
<td>gte</td>
<td>Field is Greater or egal than the value</td>
</tr>
<tr>
<td>expand</td>
<td>Modifier for expansion of placeholders in values. It replaces placeholder strings (%something%)</td>
</tr>
</tbody>
</table>
<h1 id="exemplo-de-sigma-rule-real">Exemplo de SIGMA Rule real</h1>
<p>Na realidade, apesar de uma regra SIGMA só precisar de dois campos (<code>logsource</code> e <code>detection</code>), existem muitos outros campos que servem de metadados. Por exemplo, pela documentação, o campo <code>description</code> deve conter uma descrição sobre o que aquela regra SIGMA visa detectar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Unusually Long PowerShell CommandLine</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">id</span>: <span style="color:#ae81ff">d0d28567-4b9a-45e2-8bbc-fb1b66a1f7f6</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">status</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#ae81ff">Detects unusually long PowerShell command lines with a length of 1000 characters or more</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">references</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">author</span>: <span style="color:#ae81ff">oscd.community, Natalia Shornikova</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">date</span>: <span style="color:#ae81ff">2020</span><span style="color:#ae81ff">/10/06</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">modified</span>: <span style="color:#ae81ff">2023</span><span style="color:#ae81ff">/04/14</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">attack.execution</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">attack.t1059.001</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">detection.threat_hunting</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">logsource</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">category</span>: <span style="color:#ae81ff">process_creation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">product</span>: <span style="color:#ae81ff">windows</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">detection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selection_powershell</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">Image|endswith</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#39;\powershell.exe&#39;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#39;\pwsh.exe&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">OriginalFileName</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#39;PowerShell.EXE&#39;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#39;pwsh.dll&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">Description</span>: <span style="color:#e6db74">&#39;Windows Powershell&#39;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">Product</span>: <span style="color:#e6db74">&#39;PowerShell Core 6&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selection_length</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">CommandLine|re</span>: <span style="color:#e6db74">&#39;.{1000,}&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">all of selection_*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">falsepositives</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">Unknown</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">level</span>: <span style="color:#ae81ff">low</span>
</span></span></code></pre></div><p>Atualmente, as especificações completas de regras SIGMA podem ser encontradas no repositório oficial: <a href="https://github.com/SigmaHQ/sigma-specification?tab=readme-ov-file#sigma-specification">SigmaHQ/sigma-specification: Sigma rule specification (github.com)</a></p>
<h1 id="conclusão">Conclusão</h1>
<p>Nesse artigo, foi feito uma introdução sobre como escrever regras SIGMA e uma breve explicação sobre como ocorre o processo de transformação de uma regra para uma query. Nos próximos artigos, vamos nós aprofundar em como pipelines e backends funcionam.</p>
<h1 id="reference">Reference</h1>
<p><a href="https://socprime.com/blog/sigma-rules-the-beginners-guide/#Taxonomy_Questions_eg_what_field_names_to_use">What Are SIGMA Rules: Beginner&rsquo;s Guide - SOC Prime</a> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>
<a href="https://github.com/SigmaHQ/sigma">SigmaHQ/sigma: Main Sigma Rule Repository (github.com)</a>
<a href="https://github.com/SigmaHQ/pySigma">SigmaHQ/pySigma: Python library to parse and convert Sigma rules into queries (and whatever else you could imagine) (github.com)</a>
<a href="https://sigmahq-pysigma.readthedocs.io/en/latest/index.html">pySigma Documentation — pySigma documentation (sigmahq-pysigma.readthedocs.io)</a></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Na realidade, o backend é aplicado após as transformações (pipelines).&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Esse artigo foi pesadamente inspirado nesse blog post do Adam Swan.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</div>
				
				<footer class="entry__footer">
					
<div class="entry__tags">
			<a class="entry__tag btn" href="/blog/tags/native-dll/">native-dll</a>
			<a class="entry__tag btn" href="/blog/tags/dev/">dev</a>
			<a class="entry__tag btn" href="/blog/tags/loadlibrary/">loadlibrary</a>
</div>
					
				</footer>
				
			</article>
		</div>
	</main>
	
	



	

	</div>
	<footer class="footer">
	<div class="footer__copyright">© 2024 RSI. <span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span></div>
</footer>
<script src="/blog/js/menu.js"></script>
</body>
</html>